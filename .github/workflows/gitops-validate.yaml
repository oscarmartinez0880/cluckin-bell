name: GitOps Validation

on:
  push:
    branches:
      - main
      - develop
      - staging
    paths:
      - 'charts/**'
      - 'values/**'
      - 'apps/**'
      - 'argocd/**'
      - 'Makefile'
      - '.github/workflows/gitops-validate.yaml'
  pull_request:
    branches:
      - main
      - develop
      - staging
    paths:
      - 'charts/**'
      - 'values/**'
      - 'apps/**'
      - 'argocd/**'
      - 'Makefile'
      - '.github/workflows/gitops-validate.yaml'

jobs:
  validate:
    name: GitOps Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.18.6'

      - name: Lint Helm charts
        run: make lint

      - name: Validate values files syntax
        run: |
          echo "Validating values files YAML syntax..."
          
          # Install yq for YAML validation
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Check env values - first YAML syntax, then Helm rendering
          for env_file in values/env/*.yaml; do
            echo "Checking $env_file..."
            yq eval '.' "$env_file" > /dev/null
            helm template test-release charts/app-frontend -f "$env_file" --dry-run > /dev/null
            echo "✓ $env_file is valid"
          done
          
          # Check platform values - YAML syntax only (charts have external dependencies)
          for platform_file in values/platform/*.yaml; do
            echo "Checking $platform_file..."
            yq eval '.' "$platform_file" > /dev/null
            echo "✓ $platform_file has valid YAML syntax"
            
            # Attempt Helm validation but don't fail if dependencies are missing
            if [[ "$platform_file" == *"karpenter"* ]]; then
              if helm template test-release charts/karpenter -f "$platform_file" --skip-crds --dry-run > /dev/null 2>&1; then
                echo "  ✓ Helm template validation passed"
              else
                echo "  ⚠️  Helm template validation skipped (dependencies may be missing)"
              fi
            else
              if helm template test-release charts/platform-addons -f "$platform_file" --dry-run > /dev/null 2>&1; then
                echo "  ✓ Helm template validation passed"
              else
                echo "  ⚠️  Helm template validation skipped (dependencies may be missing)"
              fi
            fi
          done
          
          echo "All values files validated successfully!"

      - name: Render templates for all environments
        run: |
          echo "Testing template rendering for all environments..."
          make render-dev > /dev/null
          echo "✓ dev templates rendered successfully"
          make render-qa > /dev/null
          echo "✓ qa templates rendered successfully"
          make render-prod > /dev/null
          echo "✓ prod templates rendered successfully"

      - name: Validate ArgoCD manifests
        run: |
          echo "Validating ArgoCD manifests YAML syntax..."
          
          # Install yq for YAML validation
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Validate ApplicationSets and Applications
          yq eval '.' apps/applicationset-apps.yaml > /dev/null && echo "✓ apps/applicationset-apps.yaml"
          yq eval '.' apps/application-platform-addons.yaml > /dev/null && echo "✓ apps/application-platform-addons.yaml"
          yq eval '.' apps/karpenter.yaml > /dev/null && echo "✓ apps/karpenter.yaml"
          yq eval '.' apps/external-secrets.yaml > /dev/null && echo "✓ apps/external-secrets.yaml"
          
          # Validate ArgoCD Projects
          yq eval '.' argocd/projects/apps-project.yaml > /dev/null && echo "✓ argocd/projects/apps-project.yaml"
          yq eval '.' argocd/projects/platform-project.yaml > /dev/null && echo "✓ argocd/projects/platform-project.yaml"
          
          echo "✓ All ArgoCD manifests are valid"

      - name: Check for common issues
        run: |
          echo "Checking for common GitOps issues..."
          
          # Check for hardcoded image tags (should use values)
          if find charts/ -name '*.yaml' -path '*/templates/*' -exec grep -l "image:.*:latest" {} \; 2>/dev/null | head -1 > /dev/null; then
            echo "⚠️  Warning: Found hardcoded ':latest' tags in templates. Consider using values."
          fi
          
          # Check for namespace references in templates
          if ! find charts/ -name '*.yaml' -path '*/templates/*' -exec grep -q "namespace:" {} \; 2>/dev/null; then
            echo "ℹ️  Note: Templates should include namespace references where appropriate"
          fi
          
          echo "✓ Common issue checks completed"

      - name: Summary
        if: always()
        run: |
          echo "==================================="
          echo "GitOps Validation Complete"
          echo "==================================="
          echo "✓ Helm charts linted"
          echo "✓ Values files validated"
          echo "✓ Templates rendered successfully"
          echo "✓ ArgoCD manifests validated"
